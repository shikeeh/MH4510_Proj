---
title: "TITLE"
author: "Chloe Neo Tze Ching, Eng Jing Keat, Goh Wei Lun Glenn, Kaneko Yoshiki, Tan Wei Keong"
date: "11 Nov 2022"
output:
  beamer_presentation:
    colortheme: seagull
    fig_caption: no
    fonttheme: structurebold
    slide_level: 2
    theme: Boadilla
    toc: yes
  slidy_presentation: default
  ioslides_presentation: default
classoption: t
header-includes: 
  - \titlegraphic{\centering \includegraphics[height=2.5cm]{fig_demogorgon.jpeg}}
  - \usepackage{animate}
fontsize: 10pt
always_allow_html: yes

---

```{r r global_options, include=FALSE, message=FALSE}
# the following command prevents all the R codes 
# from being included into the slides
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      out.width = "100%", out.height = "70%",
                      fig.align='center', fig.width=10, fig.height=7 )

library(tidyverse) # for manipulation with data
library(stargazer) # for printing nice regression tables
library(caret) # for machine learning, including KNN
library(ROCR) # for calculating ROC AUC
library(plotROC) # for plotting ROC 

```

---


# Motivation

## Problem statement

We will construct a predictive model for the price of an HDB block to help owners to identify a right moment to sell.

\medskip

\begin{figure}
\centering
\includegraphics[width = 0.8\textwidth]{fig_hdb}
\end{figure}


## Data sample

We will work with the dataset `hdb_sales.csv` - resale 
transactions of HDB units between Jan 2017 and Jun 2020
downloaded on 4 Aug 2020 from

* https://data.gov.sg/dataset/resale-flat-prices

```{r results='asis'}
hdb <- read_csv("hdb_sales.csv") %>%
  mutate(remaining_lease = ifelse(nchar(remaining_lease) > 15,
                                  remaining_lease, paste(remaining_lease, "00 months"))) %>%
  mutate(years = substr(remaining_lease, 1, 2)) %>%
  mutate(years = as.numeric(years)) %>%
  mutate(months = substr(remaining_lease, 10, 11)) %>%
  mutate(months = as.numeric(months)) %>%
  mutate(rl = years + months / 12) %>%
  mutate(remaining_lease = rl) %>%
  select(-rl)

hdb %>%
  select(month, floor_area_sqm, remaining_lease, resale_price) %>%
  mutate(remaining_lease = round(remaining_lease, 1)) %>%
  head %>%
  stargazer(type = "latex", summary = FALSE, title = "Sample of raw data")
```



## One glance at the data

Generally, large units cost more than small units:

```{r}
hdb %>%
  ggplot(aes(x = flat_type, y = resale_price, fill = flat_type)) +
  geom_violin()
```


# Modelling

Our model is 
$$
\mbox{resale price} = \beta_0+\beta_1\times\mbox{remaining lease} +
\beta_2\times\mbox{floor area}
$$


---

```{r results='asis'}
mod_lin <- lm(resale_price ~ floor_area_sqm + remaining_lease, data = hdb)
stargazer(mod_lin, omit.stat = c("f", "ser", "rsq"), 
          digits = 1,
          font.size = "small",
          single.row = TRUE,
          title = "Regression model")
```

# Analysis

Model's residual depending on the town. The most popular location is Bukit Timah (highest median price when controlled for unit area and remaining lease):

```{r}
hdb <- hdb %>%
  mutate(`predicted price` = predict(mod_lin, hdb)) %>%
  mutate(`model residual` = resale_price - `predicted price`)

hdb %>%
  ggplot(aes(x = town, y = `model residual`)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

---

Box plots by unit type

```{r fig.show = 'animate', warning=FALSE}

all_unit_types <- hdb %>% pull(flat_type) %>% unique

box_plot_by_unit_type <- function(unit_type) {
  P <- hdb %>%
    filter(flat_type == unit_type) %>%
    ggplot(aes(x = town, y = `model residual`)) +
    geom_boxplot() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    ggtitle(unit_type)
}

all_unit_types %>%
  lapply(box_plot_by_unit_type) %>%
  lapply(plot) %>%
  invisible()
```

